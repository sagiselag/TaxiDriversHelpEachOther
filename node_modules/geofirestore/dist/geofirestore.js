!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).window=t.window||{})}(this,(function(t){"use strict";const e="0123456789bcdefghjkmnpqrstuvwxyz";function r(t,e){const r=e/110574,n=Math.min(90,t.latitude+r),i=Math.max(-90,t.latitude-r),s=2*Math.floor((o=e,Math.min(_(20003930/o),110)));var o;const a=2*Math.floor(f(e,n))-1,c=2*Math.floor(f(e,i))-1;return Math.min(s,a,c,110)}function n(t,e){w(t),w(e);const r=i(e.latitude-t.latitude),n=i(e.longitude-t.longitude),s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i(t.latitude))*Math.cos(i(e.latitude))*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function i(t){if("number"!=typeof t||isNaN(t))throw new Error("Error: degrees must be a number");return t*Math.PI/180}function s(t,r=10){if(w(t),"number"!=typeof r||isNaN(r))throw new Error("precision must be a number");if(r<=0)throw new Error("precision must be greater than 0");if(r>22)throw new Error("precision cannot be greater than 22");if(Math.round(r)!==r)throw new Error("precision must be an integer");const n={min:-90,max:90},i={min:-180,max:180};let s="",o=0,a=0,c=1;for(;s.length<r;){const r=c?t.longitude:t.latitude,u=c?i:n,h=(u.min+u.max)/2;r>h?(o=1+(o<<1),u.min=h):(o=0+(o<<1),u.max=h),c=!c,a<4?a++:(a=0,s+=e[o],o=0)}return s}function o(t,e,r){return w(t),b(e),r.g={geopoint:t,geohash:e},r}function a(t){const e=Object.assign({},t);return delete e.customKey,e}function c(t,e){if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("document must be an object");const r=h(t,e?e.customKey:null,e&&(e.merge||!!e.mergeFields));if(r){return o(r,s(r),t)}return t}function u(t,e){if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("document must be an object");const r=h(t,e,!0);return r&&(t.g={geopoint:r,geohash:s(r)}),t}function h(t,e,r=!1){let n,i;if(e)if(e in t)i=t[e];else{const r=e.split(".");i=t;for(const e of r){if(!(e in i)){i=t.coordinates;break}i=i[e]}}else i=t.coordinates;if(i||(n="could not find GeoPoint"),i&&!w(i,!0)&&(n="invalid GeoPoint"),n&&!r)throw new Error("Invalid GeoFirestore document: "+n);return i}function d(t,e){const r=function(t,e){if(p(t,!0)){return{data:()=>t,distance:e?n(t.g.geopoint,e):null}}return{data:()=>t,distance:null}}(t.data(),e);return Object.assign({exists:t.exists,id:t.id},r)}function l(t,n){w(t);const i=Math.max(1,r(t,n)),o=Math.ceil(i/5),a=function(t,e){const r=e/110574,n=Math.min(90,t.latitude+r),i=Math.max(-90,t.latitude-r),s=g(e,n),o=g(e,i),a=Math.max(s,o);return[m(t.latitude,t.longitude),m(t.latitude,v(t.longitude-a)),m(t.latitude,v(t.longitude+a)),m(n,t.longitude),m(n,v(t.longitude-a)),m(n,v(t.longitude+a)),m(i,t.longitude),m(i,v(t.longitude-a)),m(i,v(t.longitude+a))]}(t,n).map(t=>function(t,r){b(t);const n=Math.ceil(r/5);if(t.length<n)return[t,t+"~"];const i=t.substring(0,n),s=i.substring(0,i.length-1),o=e.indexOf(i.charAt(i.length-1)),a=r-5*s.length,c=5-a,u=o>>c<<c,h=u+(1<<c);return h>31?[s+e[u],s+"~"]:[s+e[u],s+e[h]]}(s(t,o),i));return a.filter((t,e)=>!a.some((r,n)=>e>n&&t[0]===r[0]&&t[1]===r[1]))}function _(t){return Math.log(t)/Math.log(2)}function f(t,e){const r=g(t,e);return Math.abs(r)>1e-6?Math.max(1,_(360/r)):1}function g(t,e){const r=i(e),n=6378137*Math.cos(r)*Math.PI/180*(1/Math.sqrt(1-.00669447819799*Math.sin(r)*Math.sin(r)));return n<1e-12?t>0?360:0:Math.min(360,t/n)}function m(t,e){const r={latitude:t,longitude:e};return w(r),r}function p(t,e=!1){let r;if(t?"g"in t?(r=b(t.g.geohash,!0)?null:"invalid geohash on object",r=w(t.g.geopoint,!0)?r:"invalid location on object"):r="no `g` field found in object":r="no document found",r&&!e)throw new Error("Invalid GeoFirestore object: "+r);return!r}function b(t,r=!1){let n;if("string"!=typeof t)n="geohash must be a string";else if(0===t.length)n="geohash cannot be the empty string";else for(const r of t)-1===e.indexOf(r)&&(n="geohash cannot contain '"+r+"'");if(void 0===n||r)return!n;throw new Error("Invalid GeoFire geohash '"+t+"': "+n)}function y(t,e=!1){let r;if("number"!=typeof t||isNaN(t)?r="limit must be a number":t<0&&(r="limit must be greater than or equal to 0"),void 0===r||e)return!r;throw new Error(r)}function w(t,e=!1){let r;if(t)if(void 0===t.latitude)r="latitude must exist on GeoPoint";else if(void 0===t.longitude)r="longitude must exist on GeoPoint";else{const e=t.latitude,n=t.longitude;"number"!=typeof e||isNaN(e)?r="latitude must be a number":e<-90||e>90?r="latitude must be within the range [-90, 90]":"number"!=typeof n||isNaN(n)?r="longitude must be a number":(n<-180||n>180)&&(r="longitude must be within the range [-180, 180]")}else r="GeoPoint must exist";if(void 0===r||e)return!r;throw new Error("Invalid location: "+r)}function q(t,e=!1){if("object"!=typeof t)throw new Error("QueryCriteria must be an object");if(void 0===t.center&&void 0===t.radius)throw new Error("radius and/or center must be specified");if(e&&(void 0===t.center||void 0===t.radius))throw new Error("QueryCriteria for a new query must contain both a center and a radius");const r=Object.keys(t);for(const t of r)if(!["center","radius","limit"].includes(t))throw new Error("Unexpected attribute '"+t+"' found in query criteria");if(void 0!==t.center&&w(t.center),void 0!==t.radius){if("number"!=typeof t.radius||isNaN(t.radius))throw new Error("radius must be a number");if(t.radius<0)throw new Error("radius must be greater than or equal to 0")}void 0!==t.limit&&y(t.limit)}function v(t){if(t<=180&&t>=-180)return t;const e=t+180;return e>0?e%360-180:180- -e%360}class j{constructor(t){if(this._snapshot=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentSnapshot must be an instance of a Firestore DocumentSnapshot");this._isWeb="[object Function]"===Object.prototype.toString.call(t.ref.firestore.enablePersistence)}get native(){return this._snapshot}get exists(){return this._snapshot.exists}get id(){return this._snapshot.id}get ref(){return new M(this._snapshot.ref)}data(t){return this._isWeb&&t?this._snapshot.data(t):this._snapshot.data()}get(t,e){return this._isWeb&&e?this._snapshot.get(t,e):this._snapshot.get(t)}isEqual(t){const e=t instanceof j?t._snapshot:t;return this._snapshot.isEqual(e)}}class E{constructor(t){if(this._writeBatch=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("WriteBatch must be an instance of a Firestore WriteBatch")}get native(){return this._writeBatch}set(t,e,r){const n=t instanceof M?t._document:t;return this._writeBatch.set(n,c(e,r),a(r)),this}update(t,e,r){const n=t instanceof M?t._document:t;return this._writeBatch.update(n,u(e,r)),this}delete(t){const e=t instanceof M?t._document:t;return this._writeBatch.delete(e),this}commit(){return this._writeBatch.commit()}}class x{constructor(t){if(this._firestore=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Firestore must be an instance of Firestore")}get native(){return this._firestore}batch(){return new E(this._firestore.batch())}collection(t){return new R(this._firestore.collection(t))}runTransaction(t){return this._firestore.runTransaction(t)}}class M{constructor(t){if(this._document=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentReference must be an instance of a Firestore DocumentReference");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence)}get native(){return this._document}get id(){return this._document.id}get firestore(){return new x(this._document.firestore)}get onSnapshot(){return(t,e=(()=>{}))=>this._document.onSnapshot(e=>t(new j(e)),t=>e(t))}get parent(){return new R(this._document.parent)}get path(){return this._document.path}collection(t){return new R(this._document.collection(t))}delete(){return this._document.delete().then(()=>null)}get(t={source:"default"}){return(this._isWeb?this._document.get(t):this._document.get()).then(t=>new j(t))}isEqual(t){const e=t instanceof M?t._document:t;return this._document.isEqual(e)}set(t,e){return this._document.set(c(t,e),a(e)).then(()=>null)}update(t,e){return this._document.update(u(t,e)).then(()=>null)}}class C{constructor(t,e){this._querySnapshot=t,this._center=e,e&&w(e),this._docs=t.docs.map(t=>d(t,e))}get native(){return this._querySnapshot}get docs(){return this._docs}get size(){return this._docs.length}get empty(){return!this._docs.length}docChanges(){return(Array.isArray(this._querySnapshot.docChanges)?this._querySnapshot.docChanges:this._querySnapshot.docChanges()).map(t=>({doc:d(t.doc,this._center),newIndex:t.newIndex,oldIndex:t.oldIndex,type:t.type}))}forEach(t,e){this.docs.forEach(t,e)}}class S{constructor(t,e){if(this._queryCriteria=e,this._docs=new Map,q(e),t.forEach(t=>{t.docs.forEach(t=>{const e=n(this._queryCriteria.center,t.data().g.geopoint);this._queryCriteria.radius>=e&&this._docs.set(t.id,t)})}),this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit){const t=Array.from(this._docs.values()).map(t=>({distance:n(this._queryCriteria.center,t.data().g.geopoint),id:t.id})).sort((t,e)=>t.distance-e.distance);for(let e=this._queryCriteria.limit;e<t.length;e++)this._docs.delete(t[e].id)}}getGeoQuerySnapshot(){const t=Array.from(this._docs.values());return new C({docs:t,docChanges:()=>t.map((t,e)=>({doc:t,newIndex:e,oldIndex:-1,type:"added"}))},this._queryCriteria.center)}}class O{constructor(t,e,r,n=(()=>{})){this._queries=t,this._queryCriteria=e,this._onNext=r,this._onError=n,this._docs=new Map,this._firstRoundResolved=!1,this._firstEmitted=!1,this._newValues=!1,this._subscriptions=[],this._queriesResolved=[],q(e),this._queriesResolved=new Array(t.length).fill(0),t.forEach((t,e)=>{const r=t.onSnapshot(t=>this._processSnapshot(t,e),t=>this._error=t);this._subscriptions.push(r)}),this._interval=setInterval(()=>this._emit(),100)}unsubscribe(){return()=>{clearInterval(this._interval),this._subscriptions.forEach(t=>t())}}_next(){if(this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit){const t=Array.from(this._docs.values()).sort((t,e)=>t.distance-e.distance);for(let e=this._queryCriteria.limit;e<t.length;e++)if(t[e].emitted){const r={change:Object.assign({},t[e].change),distance:t[e].distance,emitted:t[e].emitted};r.change.type="removed",this._docs.set(r.change.doc.id,r)}else this._docs.delete(t[e].change.doc.id)}let t=0;const e=Array.from(this._docs.values()).map((e,r)=>{const n={type:e.change.type,doc:e.change.doc,oldIndex:e.emitted?e.change.newIndex:-1,newIndex:"removed"!==e.change.type?r-t:-1};return"removed"===n.type?(t--,this._docs.delete(n.doc.id)):this._docs.set(n.doc.id,{change:n,distance:e.distance,emitted:!0}),n}),r=e.reduce((t,e)=>(e.newIndex>=0?t.push(e.doc):this._docs.delete(e.doc.id),t),[]);this._firstEmitted=!0,this._onNext(new C({docs:r,docChanges:()=>e.reduce((t,e)=>(-1!==e.oldIndex&&"added"===e.type||t.push(e),t),[])},this._queryCriteria.center))}_emit(){this._error?(this._onError(this._error),this.unsubscribe()()):this._newValues&&this._firstRoundResolved?(this._newValues=!1,this._next()):this._firstRoundResolved||(this._firstRoundResolved=this._queriesResolved.reduce((t,e)=>t+e,0)===this._queries.length)}_processSnapshot(t,e){const r=Array.isArray(t.docChanges)?t.docChanges:t.docChanges();this._firstRoundResolved||(this._queriesResolved[e]=1),r.length?r.forEach(t=>{const e=t.doc.data(),r=p(e,!0)?e.g.geopoint:null,i=r?n(this._queryCriteria.center,r):null,s=t.doc.id,o=this._docs.get(s),a={change:{doc:t.doc,oldIndex:o&&this._firstEmitted?o.change.oldIndex:-1,newIndex:o&&this._firstEmitted?o.change.newIndex:-1,type:o&&this._firstEmitted?t.type:"added"},distance:i,emitted:!!this._firstEmitted&&!!o};if(this._queryCriteria.radius>=i){if(!o&&"removed"===a.change.type)return;o||"modified"!==a.change.type||(a.change.type="added"),this._newValues=!0,this._docs.set(s,a)}else o?(a.change.type="removed",this._newValues=!0,this._docs.set(s,a)):o||this._firstRoundResolved||(this._newValues=!0)}):this._firstRoundResolved||(this._newValues=!0)}}class I{constructor(t,e){if(this._query=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Query must be an instance of a Firestore Query");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence),e&&("number"==typeof e.limit&&(this._limit=e.limit),e.center&&"number"==typeof e.radius&&(q(e),this._center=e.center,this._radius=e.radius))}get native(){return this._query}get firestore(){return new x(this._query.firestore)}get onSnapshot(){return(t,e=(()=>{}))=>{if(this._center&&"number"==typeof this._radius)return new O(this._generateQuery(),this._queryCriteria,t,e).unsubscribe();return(this._limit?this._query.limit(this._limit):this._query).onSnapshot(e=>t(new C(e)),e)}}get(t={source:"default"}){if(this._center&&"number"==typeof this._radius){const e=this._generateQuery().map(e=>this._isWeb?e.get(t):e.get());return Promise.all(e).then(t=>new S(t,this._queryCriteria).getGeoQuerySnapshot())}{const e=this._limit?this._query.limit(this._limit):this._query;return(this._isWeb?e.get(t):e.get()).then(t=>new C(t))}}limit(t){return y(t),this._limit=t,new I(this._query,this._queryCriteria)}near(t){return q(t,!0),this._center=t.center,this._radius=t.radius,new I(this._query,this._queryCriteria)}where(t,e,r){return new I(this._query.where(t,e,r),this._queryCriteria)}_generateQuery(){let t=l(this._center,1e3*this._radius).map(this._queryToString);return t=t.filter((e,r)=>t.indexOf(e)===r),t.map(t=>{const e=this._stringToQuery(t);return this._query.orderBy("g.geohash").startAt(e[0]).endAt(e[1])})}get _queryCriteria(){return{center:this._center,limit:this._limit,radius:this._radius}}_stringToQuery(t){const e=t.split(":");if(2!==e.length)throw new Error("Invalid internal state! Not a valid geohash query: "+t);return e}_queryToString(t){if(2!==t.length)throw new Error("Not a valid geohash query: "+t);return t[0]+":"+t[1]}}class R extends I{constructor(t){super(t),this._collection=t}get native(){return this._collection}get id(){return this._collection.id}get parent(){return this._collection.parent?new M(this._collection.parent):null}get path(){return this._collection.path}add(t,e){return this._collection.add(function(t,e){if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("document must be an object");const r=h(t,e);return o(r,s(r),t)}(t,e)).then(t=>new M(t))}doc(t){return new M(t?this._collection.doc(t):this._collection.doc())}}t.GeoCollectionReference=R,t.GeoDocumentReference=M,t.GeoDocumentSnapshot=j,t.GeoFirestore=x,t.GeoQuery=I,t.GeoQuerySnapshot=C,t.GeoTransaction=class{constructor(t){if(this._transaction=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Transaction must be an instance of a Firestore Transaction")}get native(){return this._transaction}delete(t){const e=t instanceof M?t._document:t;return this._transaction.delete(e),this}get(t){const e=t instanceof M?t._document:t;return this._transaction.get(e).then(t=>new j(t))}set(t,e,r){const n=t instanceof M?t._document:t;return this._transaction.set(n,c(e,r),a(r)),this}update(t,e,r){const n=t instanceof M?t._document:t;return this._transaction.update(n,u(e,r)),this}},t.GeoWriteBatch=E,Object.defineProperty(t,"__esModule",{value:!0})}));
